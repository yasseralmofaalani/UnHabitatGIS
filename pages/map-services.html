<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خدمات الخريطة</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Cairo (Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --secondary-color: #10b981;
            --text-color: #1f2937;
            --light-bg: #f9fafb;
            --border-color: #e5e7eb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .logo img, .logo svg {
            width: 40px;
            height: 40px;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .map-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (min-width: 1024px) {
            .map-container {
                flex-direction: row;
            }
        }
        
        .controls-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 20px;
            height: fit-content;
        }
        
        @media (min-width: 1024px) {
            .controls-panel {
                width: 25%;
            }
        }
        
        .map-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            height: 700px;
            overflow: hidden;
        }
        
        @media (min-width: 1024px) {
            .map-panel {
                width: 75%;
            }
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .buttons-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: #f3f4f6;
        }
        
        .btn i {
            margin-left: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #0d9668;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn-icon {
            padding: 8px;
        }
        
        .layer-controls {
            margin-top: 10px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .layer-checkbox, .layer-radio {
            margin-left: 8px;
        }
        
        .layer-name {
            display: flex;
            align-items: center;
        }
        
        .layer-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            display: inline-block;
        }
        
        .measurements-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        
        .measurements-table th, .measurements-table td {
            padding: 10px;
            text-align: right;
            border: 1px solid var(--border-color);
        }
        
        .measurements-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        
        .measurements-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .measurements-table tr:hover {
            background-color: #f3f4f6;
        }
        
        /* Custom control styling */
        .custom-control {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .control-button {
            display: block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .control-button:last-child {
            border-bottom: none;
        }
        
        .control-button:hover {
            background-color: #f3f4f6;
        }
        
        /* Notification styles */
        .notifications {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        
        .notification {
            background-color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification-success {
            border-right: 4px solid var(--secondary-color);
        }
        
        .notification-error {
            border-right: 4px solid #ef4444;
        }
        
        .notification-info {
            border-right: 4px solid var(--primary-light);
        }
        
        .notification-icon {
            margin-left: 12px;
            font-size: 20px;
        }
        
        .notification-success .notification-icon {
            color: var(--secondary-color);
        }
        
        .notification-error .notification-icon {
            color: #ef4444;
        }
        
        .notification-info .notification-icon {
            color: var(--primary-light);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .notification-message {
            font-size: 0.9rem;
            color: #4b5563;
        }
        
        .notification-close {
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            margin-right: 8px;
        }
        
        .notification-close:hover {
            color: #4b5563;
        }
        
        /* RTL specific adjustments for Leaflet */
        .leaflet-right {
            right: auto;
            left: 10px;
        }
        
        .leaflet-left {
            left: auto;
            right: 10px;
        }
        
        .leaflet-popup-content {
            text-align: right;
        }
        
        /* Custom Marker Cluster Styling */
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        
        .marker-cluster div {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            margin-left: 0;
            margin-top: 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .marker-cluster span {
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
        }
        
        /* Measurement result labels */
        .measurement-label {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 4px 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            margin-top: -12px;
            white-space: nowrap;
            font-weight: 600;
            direction: ltr;
        }
        
        /* For print */
        @media print {
            .controls-panel, 
            .header,
            .leaflet-control-container,
            .notification {
                display: none !important;
            }
            
            .map-panel {
                width: 100% !important;
                height: 100vh !important;
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <svg width="40" height="40" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="256" height="256" rx="100" fill="#E6F2FF"/>
                    <path d="M128 48C81.6 48 48 81.6 48 128C48 174.4 81.6 208 128 208C174.4 208 208 174.4 208 128C208 81.6 174.4 48 128 48ZM180 136H136V180H120V136H76V120H120V76H136V120H180V136Z" fill="#1e40af"/>
                </svg>
                <span class="logo-text">نظام الخرائط</span>
            </a>
        </div>
    </header>

    <div class="container">
        <h1 class="section-title">خدمات الخريطة</h1>
        
        <div class="map-container">
            <!-- Controls Panel -->
            <div class="controls-panel">
                <!-- Zoom Controls -->
                <div class="control-section">
                    <h3 class="control-section-title">التكبير والتصغير</h3>
                    <div class="buttons-group">
                        <button id="zoom-in" class="btn btn-sm">
                            <i class="fa-solid fa-magnifying-glass-plus"></i>
                            تكبير
                        </button>
                        <button id="zoom-out" class="btn btn-sm">
                            <i class="fa-solid fa-magnifying-glass-minus"></i>
                            تصغير
                        </button>
                        <button id="home-view" class="btn btn-sm">
                            <i class="fa-solid fa-house"></i>
                            العودة للمركز
                        </button>
                    </div>
                </div>
                
                <!-- Measurement Tools -->
                <div class="control-section">
                    <h3 class="control-section-title">أدوات القياس</h3>
                    <div class="buttons-group">
                        <button id="measure-distance" class="btn btn-sm">
                            <i class="fa-solid fa-ruler"></i>
                            قياس المسافة
                        </button>
                        <button id="measure-area" class="btn btn-sm">
                            <i class="fa-solid fa-draw-polygon"></i>
                            قياس المساحة
                        </button>
                    </div>
                </div>
                
                <!-- Layer Controls -->
                <div class="control-section">
                    <h3 class="control-section-title">الطبقات</h3>
                    <div class="layer-controls">
                        <div class="layer-group">
                            <div class="font-medium">طبقات الخريطة الأساسية:</div>
                            <div class="layer-item">
                                <input type="radio" id="base-layer-1" name="baseLayer" class="layer-radio" checked>
                                <label for="base-layer-1" class="layer-name">خريطة الشوارع</label>
                            </div>
                            <div class="layer-item">
                                <input type="radio" id="base-layer-2" name="baseLayer" class="layer-radio">
                                <label for="base-layer-2" class="layer-name">خريطة الأقمار الصناعية</label>
                            </div>
                        </div>
                        
                        <div class="layer-group" style="margin-top: 15px;">
                            <div class="font-medium">الطبقات الإضافية:</div>
                            <div class="layer-item">
                                <input type="checkbox" id="overlay-layer-1" class="layer-checkbox" checked>
                                <label for="overlay-layer-1" class="layer-name">
                                    <span class="layer-color" style="background-color: #ff0000;"></span>
                                    المناطق السكنية
                                </label>
                            </div>
                            <div class="layer-item">
                                <input type="checkbox" id="overlay-layer-2" class="layer-checkbox" checked>
                                <label for="overlay-layer-2" class="layer-name">
                                    <span class="layer-color" style="background-color: #0000ff;"></span>
                                    المناطق التجارية
                                </label>
                            </div>
                            <div class="layer-item">
                                <input type="checkbox" id="overlay-layer-3" class="layer-checkbox">
                                <label for="overlay-layer-3" class="layer-name">
                                    <span class="layer-color" style="background-color: #ffff00;"></span>
                                    المناطق الصناعية
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Export/Print Controls -->
                <div class="control-section">
                    <h3 class="control-section-title">التصدير والطباعة</h3>
                    <div class="buttons-group">
                        <button id="print-map" class="btn btn-sm">
                            <i class="fa-solid fa-print"></i>
                            طباعة
                        </button>
                        <button id="export-map" class="btn btn-sm">
                            <i class="fa-solid fa-download"></i>
                            تصدير كصورة
                        </button>
                    </div>
                </div>
                
                <!-- Clear Controls -->
                <button id="clear-measurements" class="btn btn-danger btn-sm">
                    <i class="fa-solid fa-trash"></i>
                    مسح جميع القياسات
                </button>
            </div>
            
            <!-- Map Panel -->
            <div class="map-panel">
                <div id="map"></div>
            </div>
        </div>
        
        <!-- Measurements Table -->
        <div id="measurements-table-container" style="display: none; margin-top: 20px;">
            <div class="section-title">قائمة القياسات</div>
            <table class="measurements-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>نوع القياس</th>
                        <th>القيمة</th>
                        <th>الوحدة</th>
                        <th>التاريخ</th>
                    </tr>
                </thead>
                <tbody id="measurements-table-body">
                    <!-- Measurements will be added here dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Notifications Container -->
    <div class="notifications" id="notifications"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw JS -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- html2canvas for export functionality -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        // Initialize Map
        document.addEventListener('DOMContentLoaded', function() {
            // Map initialization
            const map = L.map('map', {
                center: [24.774265, 46.738586], // Riyadh, Saudi Arabia
                zoom: 12,
                zoomControl: false, // We'll add custom zoom controls
                attributionControl: true
            });
            
            // Base Layers
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
            
            // Feature Groups for Overlay Layers with Clustering
            const residentialLayer = L.markerClusterGroup({
                showCoverageOnHover: false,
                spiderfyOnMaxZoom: true,
                disableClusteringAtZoom: 16,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    return new L.DivIcon({
                        html: `<div style="background-color: #ef4444"><span>${cluster.getChildCount()}</span></div>`,
                        className: 'marker-cluster',
                        iconSize: new L.Point(40, 40)
                    });
                }
            }).addTo(map);
            
            const commercialLayer = L.markerClusterGroup({
                showCoverageOnHover: false,
                spiderfyOnMaxZoom: true,
                disableClusteringAtZoom: 16,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    return new L.DivIcon({
                        html: `<div style="background-color: #3b82f6"><span>${cluster.getChildCount()}</span></div>`,
                        className: 'marker-cluster',
                        iconSize: new L.Point(40, 40)
                    });
                }
            }).addTo(map);
            
            const industrialLayer = L.markerClusterGroup({
                showCoverageOnHover: false,
                spiderfyOnMaxZoom: true,
                disableClusteringAtZoom: 16,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    return new L.DivIcon({
                        html: `<div style="background-color: #a855f7"><span>${cluster.getChildCount()}</span></div>`,
                        className: 'marker-cluster',
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            
            // Sample data for overlay layers
            const sampleResidentialAreas = [
                { lat: 24.774265, lng: 46.738586, radius: 500, name: 'منطقة سكنية 1' },
                { lat: 24.764265, lng: 46.728586, radius: 700, name: 'منطقة سكنية 2' },
                { lat: 24.784265, lng: 46.748586, radius: 300, name: 'منطقة سكنية 3' }
            ];
            
            const sampleCommercialAreas = [
                { lat: 24.769265, lng: 46.743586, radius: 400, name: 'منطقة تجارية 1' },
                { lat: 24.779265, lng: 46.733586, radius: 250, name: 'منطقة تجارية 2' }
            ];
            
            const sampleIndustrialAreas = [
                { lat: 24.755265, lng: 46.728586, radius: 600, name: 'منطقة صناعية 1' },
                { lat: 24.795265, lng: 46.758586, radius: 350, name: 'منطقة صناعية 2' }
            ];
            
            // Create custom marker icons
            const createCustomIcon = (color, type) => {
                return L.divIcon({
                    className: 'custom-marker-icon',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-${type === 'residential' ? 'home' : type === 'commercial' ? 'store' : 'industry'}" style="color: white; font-size: 12px;"></i>
                           </div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
            };

            // Add sample data to layers
            sampleResidentialAreas.forEach(area => {
                // Add circle
                L.circle([area.lat, area.lng], {
                    radius: area.radius,
                    color: '#ff0000',
                    fillColor: '#ff3333',
                    fillOpacity: 0.3
                }).addTo(residentialLayer);
                
                // Add marker at center with custom icon
                L.marker([area.lat, area.lng], {
                    icon: createCustomIcon('#ff0000', 'residential')
                }).bindPopup(`
                    <div class="popup-header" style="background-color: #ef4444; color: white; padding: 8px; border-radius: 4px 4px 0 0;">
                        <h3 style="margin: 0; font-size: 16px;">${area.name}</h3>
                    </div>
                    <div class="popup-content" style="padding: 8px;">
                        <p style="margin: 0 0 5px 0;"><strong>نوع المنطقة:</strong> سكنية</p>
                        <p style="margin: 0 0 5px 0;"><strong>المساحة:</strong> ${(Math.PI * area.radius * area.radius / 1000000).toFixed(2)} كم²</p>
                        <p style="margin: 0;"><strong>الإحداثيات:</strong> ${area.lat.toFixed(4)}, ${area.lng.toFixed(4)}</p>
                    </div>
                `).addTo(residentialLayer);
            });
            
            sampleCommercialAreas.forEach(area => {
                // Add circle
                L.circle([area.lat, area.lng], {
                    radius: area.radius,
                    color: '#0000ff',
                    fillColor: '#3333ff',
                    fillOpacity: 0.3
                }).addTo(commercialLayer);
                
                // Add marker at center with custom icon
                L.marker([area.lat, area.lng], {
                    icon: createCustomIcon('#3b82f6', 'commercial')
                }).bindPopup(`
                    <div class="popup-header" style="background-color: #3b82f6; color: white; padding: 8px; border-radius: 4px 4px 0 0;">
                        <h3 style="margin: 0; font-size: 16px;">${area.name}</h3>
                    </div>
                    <div class="popup-content" style="padding: 8px;">
                        <p style="margin: 0 0 5px 0;"><strong>نوع المنطقة:</strong> تجارية</p>
                        <p style="margin: 0 0 5px 0;"><strong>المساحة:</strong> ${(Math.PI * area.radius * area.radius / 1000000).toFixed(2)} كم²</p>
                        <p style="margin: 0;"><strong>الإحداثيات:</strong> ${area.lat.toFixed(4)}, ${area.lng.toFixed(4)}</p>
                    </div>
                `).addTo(commercialLayer);
            });
            
            sampleIndustrialAreas.forEach(area => {
                // Add circle
                L.circle([area.lat, area.lng], {
                    radius: area.radius,
                    color: '#a855f7',
                    fillColor: '#a855f7',
                    fillOpacity: 0.3
                }).addTo(industrialLayer);
                
                // Add marker at center with custom icon
                L.marker([area.lat, area.lng], {
                    icon: createCustomIcon('#a855f7', 'industry')
                }).bindPopup(`
                    <div class="popup-header" style="background-color: #a855f7; color: white; padding: 8px; border-radius: 4px 4px 0 0;">
                        <h3 style="margin: 0; font-size: 16px;">${area.name}</h3>
                    </div>
                    <div class="popup-content" style="padding: 8px;">
                        <p style="margin: 0 0 5px 0;"><strong>نوع المنطقة:</strong> صناعية</p>
                        <p style="margin: 0 0 5px 0;"><strong>المساحة:</strong> ${(Math.PI * area.radius * area.radius / 1000000).toFixed(2)} كم²</p>
                        <p style="margin: 0;"><strong>الإحداثيات:</strong> ${area.lat.toFixed(4)}, ${area.lng.toFixed(4)}</p>
                    </div>
                `).addTo(industrialLayer);
            });
            
            // Feature Group for Measurements
            const measurementsLayer = L.featureGroup().addTo(map);
            
            // Initialize draw control
            const drawControl = new L.Control.Draw({
                draw: {
                    polyline: {
                        shapeOptions: {
                            color: '#f357a1',
                            weight: 4
                        },
                        metric: true
                    },
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>خطأ:</strong> لا يمكن أن تتقاطع حدود المضلع!'
                        },
                        shapeOptions: {
                            color: '#3388ff'
                        },
                        showArea: true
                    },
                    circle: false,
                    rectangle: false,
                    marker: true,
                    circlemarker: false
                },
                edit: {
                    featureGroup: measurementsLayer,
                    remove: true
                }
            });
            
            // Add scale control
            L.control.scale({
                imperial: false,
                metric: true,
                position: 'bottomleft'
            }).addTo(map);
            
            // Add custom zoom controls
            const customZoomControl = L.control({ position: 'topleft' });
            customZoomControl.onAdd = function() {
                const container = L.DomUtil.create('div', 'custom-control');
                container.innerHTML = `
                    <a href="#" title="تكبير" class="control-button zoom-in">+</a>
                    <a href="#" title="تصغير" class="control-button zoom-out">-</a>
                    <a href="#" title="العودة للمركز" class="control-button home">⌂</a>
                `;
                
                // Add event listeners
                L.DomEvent.on(container.querySelector('.zoom-in'), 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    map.zoomIn();
                });
                
                L.DomEvent.on(container.querySelector('.zoom-out'), 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    map.zoomOut();
                });
                
                L.DomEvent.on(container.querySelector('.home'), 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    map.setView([24.774265, 46.738586], 12);
                });
                
                return container;
            };
            customZoomControl.addTo(map);
            
            // State variables
            let measureMode = null;
            const measurements = [];
            
            // Event handlers for UI buttons
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            document.getElementById('home-view').addEventListener('click', () => map.setView([24.774265, 46.738586], 12));
            
            document.getElementById('measure-distance').addEventListener('click', function() {
                toggleMeasureMode('distance', this);
            });
            
            document.getElementById('measure-area').addEventListener('click', function() {
                toggleMeasureMode('area', this);
            });
            
            document.getElementById('print-map').addEventListener('click', printMap);
            document.getElementById('export-map').addEventListener('click', exportMap);
            document.getElementById('clear-measurements').addEventListener('click', clearMeasurements);
            
            // Layer control handlers
            document.getElementById('base-layer-1').addEventListener('change', function() {
                if (this.checked) {
                    map.removeLayer(satelliteLayer);
                    map.addLayer(streetLayer);
                }
            });
            
            document.getElementById('base-layer-2').addEventListener('change', function() {
                if (this.checked) {
                    map.removeLayer(streetLayer);
                    map.addLayer(satelliteLayer);
                }
            });
            
            document.getElementById('overlay-layer-1').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(residentialLayer);
                } else {
                    map.removeLayer(residentialLayer);
                }
            });
            
            document.getElementById('overlay-layer-2').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(commercialLayer);
                } else {
                    map.removeLayer(commercialLayer);
                }
            });
            
            document.getElementById('overlay-layer-3').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(industrialLayer);
                } else {
                    map.removeLayer(industrialLayer);
                }
            });
            
            // Handle draw events
            map.on(L.Draw.Event.CREATED, function(event) {
                const layer = event.layer;
                measurementsLayer.addLayer(layer);
                
                // If measuring, calculate and display measurement
                if (measureMode) {
                    let measurement = 0;
                    let unit = '';
                    
                    if (measureMode === 'distance') {
                        if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                            measurement = calculatePolylineDistance(layer);
                            unit = 'متر';
                            
                            if (measurement >= 1000) {
                                measurement = measurement / 1000;
                                unit = 'كم';
                            }
                        }
                    } else if (measureMode === 'area') {
                        if (layer instanceof L.Polygon) {
                            measurement = calculatePolygonArea(layer);
                            unit = 'متر²';
                            
                            if (measurement >= 1000000) {
                                measurement = measurement / 1000000;
                                unit = 'كم²';
                            }
                        }
                    }
                    
                    if (measurement > 0) {
                        const center = layer instanceof L.Polygon ? layer.getBounds().getCenter() : getPolylineCenter(layer);
                        
                        // Add measurement label
                        L.marker(center, {
                            icon: L.divIcon({
                                className: 'measurement-label',
                                html: `${measurement.toFixed(2)} ${unit}`,
                                iconSize: [100, 40]
                            }),
                            interactive: false
                        }).addTo(measurementsLayer);
                        
                        // Add to measurements array
                        const newMeasurement = {
                            id: Date.now(),
                            type: measureMode,
                            value: measurement,
                            unit: unit,
                            date: new Date().toLocaleDateString('ar-EG')
                        };
                        
                        measurements.push(newMeasurement);
                        updateMeasurementsTable();
                    }
                    
                    // Reset measure mode
                    resetMeasureMode();
                }
            });
            
            // Functions
            function toggleMeasureMode(mode, button) {
                // Deactivate current mode if it's the same
                if (measureMode === mode) {
                    resetMeasureMode();
                    return;
                }
                
                // Reset previous mode
                resetMeasureMode();
                
                // Set new mode
                measureMode = mode;
                document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('btn-active'));
                button.classList.add('btn-active');
                
                // Start drawing
                if (mode === 'distance') {
                    new L.Draw.Polyline(map).enable();
                    showNotification('وضع القياس', 'انقر على الخريطة لبدء قياس المسافة', 'info');
                } else if (mode === 'area') {
                    new L.Draw.Polygon(map).enable();
                    showNotification('وضع القياس', 'ارسم مضلع على الخريطة لقياس المساحة', 'info');
                }
            }
            
            function resetMeasureMode() {
                measureMode = null;
                document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('btn-active'));
                
                // Disable any active drawing
                if (map.currentActiveDrawing) {
                    map.currentActiveDrawing.disable();
                    map.currentActiveDrawing = null;
                }
            }
            
            function calculatePolylineDistance(polyline) {
                const latlngs = polyline.getLatLngs();
                let totalDistance = 0;
                
                for (let i = 1; i < latlngs.length; i++) {
                    totalDistance += latlngs[i-1].distanceTo(latlngs[i]);
                }
                
                return totalDistance;
            }
            
            function calculatePolygonArea(polygon) {
                const latlngs = polygon.getLatLngs()[0];
                return L.GeometryUtil.geodesicArea(latlngs);
            }
            
            function getPolylineCenter(polyline) {
                const latlngs = polyline.getLatLngs();
                
                if (latlngs.length === 0) return null;
                if (latlngs.length === 1) return latlngs[0];
                
                // Find middle point
                const middle = Math.floor(latlngs.length / 2);
                return latlngs[middle];
            }
            
            function updateMeasurementsTable() {
                const tableContainer = document.getElementById('measurements-table-container');
                const tableBody = document.getElementById('measurements-table-body');
                
                if (measurements.length > 0) {
                    tableContainer.style.display = 'block';
                    
                    // Clear the table
                    tableBody.innerHTML = '';
                    
                    // Add rows
                    measurements.forEach((measurement, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${measurement.type === 'distance' ? 'قياس المسافة' : 'قياس المساحة'}</td>
                            <td>${measurement.value.toFixed(2)}</td>
                            <td>${measurement.unit}</td>
                            <td>${measurement.date}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableContainer.style.display = 'none';
                }
            }
            
            function clearMeasurements() {
                // Clear all measurements
                measurementsLayer.clearLayers();
                measurements.length = 0;
                updateMeasurementsTable();
                showNotification('تم المسح', 'تم مسح جميع القياسات بنجاح', 'success');
            }
            
            function printMap() {
                showNotification('جاري الطباعة', 'تم إرسال الخريطة للطباعة', 'info');
                window.print();
            }
            
            function exportMap() {
                showNotification('جاري التصدير', 'يتم تصدير الخريطة كصورة...', 'info');
                
                html2canvas(document.getElementById('map')).then(canvas => {
                    // Create image
                    const image = canvas.toDataURL('image/png');
                    
                    // Create a temporary link and click it to download
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = 'map-export-' + new Date().toISOString().slice(0, 10) + '.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('تم التصدير', 'تم تصدير الخريطة بنجاح', 'success');
                }).catch(err => {
                    console.error('Error exporting map:', err);
                    showNotification('خطأ في التصدير', 'حدث خطأ أثناء تصدير الخريطة', 'error');
                });
            }
            
            function showNotification(title, message, type = 'info') {
                const notificationsContainer = document.getElementById('notifications');
                
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                
                // Icon based on type
                let icon = 'fa-info-circle';
                if (type === 'success') icon = 'fa-check-circle';
                if (type === 'error') icon = 'fa-exclamation-circle';
                
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <div class="notification-close">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                // Add the notification to the container
                notificationsContainer.appendChild(notification);
                
                // Add event listener to close button
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });
                
                // Show the notification (with animation)
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 5000);
            }
        });
    </script>
</body>
</html>